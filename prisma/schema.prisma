// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  passwordHash       String
  role               UserRole  @default(STUDENT)
  isVerified         Boolean   @default(false)
  verificationToken  String?
  resetToken         String?
  resetTokenExpiry   DateTime?
  twoFactorEnabled   Boolean   @default(false)
  twoFactorSecret    String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastLoginAt        DateTime?

  // Relations
  student                  Student?
  instructor               Instructor?
  admin                    Admin?
  notifications            Notification[]
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  messageReactions         MessageReaction[]
  messageReadReceipts      MessageReadReceipt[]
  onlineStatus             OnlineStatus?

  @@map("users")
}

// ============================================
// STUDENT MODEL
// ============================================

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
}

model Student {
  id               String           @id @default(uuid())
  userId           String           @unique
  firstName        String
  lastName         String
  phone            String?
  dateOfBirth      DateTime?
  gender           String?
  address          String?
  city             String?
  state            String?
  country          String?
  photoUrl         String?
  idDocumentUrl    String?
  resumeUrl        String?
  educationLevel   String?
  institution      String?
  fieldOfStudy     String?
  techInterests    String[]
  priorExperience  String?
  enrollmentDate   DateTime         @default(now())
  enrollmentStatus EnrollmentStatus @default(PENDING)
  cohortId         String?
  termsAccepted    Boolean          @default(false)
  termsAcceptedAt  DateTime?
  totalPoints      Int              @default(0)
  currentStreak    Int              @default(0)
  longestStreak    Int              @default(0)
  lastActivityDate DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  cohort            Cohort?             @relation(fields: [cohortId], references: [id])
  attendance        Attendance[]
  projects          Project[]
  assessments       AssessmentResult[]
  skillProficiency  SkillProficiency[]
  progress          Progress[]
  achievements      Achievement[]
  certificates      Certificate[]
  feedback          Feedback[]
  recommendations   Recommendation[]
  activities        Activity[]

  @@map("students")
}

// ============================================
// INSTRUCTOR MODEL
// ============================================

model Instructor {
  id            String   @id @default(uuid())
  userId        String   @unique
  firstName     String
  lastName      String
  phone         String?
  bio           String?
  expertise     String[]
  photoUrl      String?
  linkedinUrl   String?
  githubUrl     String?
  yearsOfExp    Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes   Class[]
  feedback  Feedback[]

  @@map("instructors")
}

// ============================================
// ADMIN MODEL
// ============================================

model Admin {
  id          String   @id @default(uuid())
  userId      String   @unique
  firstName   String
  lastName    String
  phone       String?
  permissions String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

// ============================================
// COHORT MODEL
// ============================================

model Cohort {
  id          String    @id @default(uuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  maxStudents Int       @default(30)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  students      Student[]
  classes       Class[]
  conversations Conversation[]

  @@map("cohorts")
}

// ============================================
// CLASS MODEL
// ============================================

enum ClassType {
  LECTURE
  WORKSHOP
  LAB
  PROJECT_REVIEW
  GUEST_SPEAKER
  ASSESSMENT
}

enum DeliveryMode {
  IN_PERSON
  ZOOM
  HYBRID
}

model Class {
  id            String       @id @default(uuid())
  cohortId      String
  instructorId  String
  title         String
  description   String?
  classType     ClassType
  deliveryMode  DeliveryMode
  topic         String
  monthNumber   Int
  weekNumber    Int
  scheduledAt   DateTime
  duration      Int // in minutes
  zoomLink      String?
  recordingUrl  String?
  materialsUrl  String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  cohort        Cohort              @relation(fields: [cohortId], references: [id])
  instructor    Instructor          @relation(fields: [instructorId], references: [id])
  attendance    Attendance[]
  qrCodes       AttendanceQRCode[]
  conversations Conversation[]

  @@map("classes")
}

// ============================================
// ATTENDANCE MODEL
// ============================================

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AttendanceMethod {
  QR_CODE
  ZOOM_AUTO
  MANUAL
}

model Attendance {
  id                 String           @id @default(uuid())
  studentId          String
  classId            String
  status             AttendanceStatus
  method             AttendanceMethod
  checkInTime        DateTime?
  lateMinutes        Int              @default(0)
  participationScore Int?
  notes              String?
  latitude           Float?
  longitude          Float?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id])

  @@unique([studentId, classId])
  @@map("attendance")
}

// ============================================
// QR CODE MODEL
// ============================================

model AttendanceQRCode {
  id        String   @id @default(uuid())
  classId   String
  code      String   @unique
  expiresAt DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  class Class @relation(fields: [classId], references: [id])

  @@map("attendance_qr_codes")
}

// ============================================
// PROJECT MODEL
// ============================================

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  NEEDS_REVISION
  APPROVED
  REJECTED
}

model Project {
  id              String        @id @default(uuid())
  studentId       String
  title           String
  description     String
  monthNumber     Int
  githubUrl       String?
  liveUrl         String?
  videoUrl        String?
  technologies    String[]
  status          ProjectStatus @default(NOT_STARTED)
  isCapstone      Boolean       @default(false)
  submittedAt     DateTime?
  reviewedAt      DateTime?
  feedback        String?
  overallScore    Int?
  codeQuality     Int?
  functionality   Int?
  design          Int?
  documentation   Int?
  innovation      Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("projects")
}

// ============================================
// ASSIGNMENT MODEL
// ============================================

enum AssignmentType {
  QUIZ
  CODING_CHALLENGE
  PRACTICAL_EXAM
  PEER_REVIEW
  ESSAY
  VIDEO_SUBMISSION
}

model Assignment {
  id            String         @id @default(uuid())
  title         String
  description   String
  type          AssignmentType
  monthNumber   Int
  weekNumber    Int
  topic         String
  instructions  String
  resourceUrls  String[]
  maxScore      Int            @default(100)
  passingScore  Int            @default(70)
  dueDate       DateTime
  allowLate     Boolean        @default(false)
  latePenalty   Int            @default(10)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  results AssessmentResult[]

  @@map("assignments")
}

// ============================================
// ASSESSMENT RESULT MODEL
// ============================================

model AssessmentResult {
  id           String    @id @default(uuid())
  studentId    String
  assignmentId String
  submittedAt  DateTime?
  score        Int?
  percentage   Float?
  feedback     String?
  isLate       Boolean   @default(false)
  attemptCount Int       @default(1)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignment Assignment @relation(fields: [assignmentId], references: [id])

  @@unique([studentId, assignmentId])
  @@map("assessment_results")
}

// ============================================
// SKILL PROFICIENCY MODEL
// ============================================

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model SkillProficiency {
  id               String     @id @default(uuid())
  studentId        String
  skillName        String
  category         String
  proficiencyScore Int        @default(0)
  level            SkillLevel @default(BEGINNER)
  lastAssessedAt   DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, skillName])
  @@map("skill_proficiency")
}

// ============================================
// PROGRESS TRACKING MODEL
// ============================================

model Progress {
  id                  String   @id @default(uuid())
  studentId           String
  monthNumber         Int
  weekNumber          Int
  classesAttended     Int      @default(0)
  totalClasses        Int      @default(0)
  attendanceRate      Float    @default(0)
  projectsCompleted   Int      @default(0)
  projectsRequired    Int      @default(0)
  assignmentsSubmitted Int     @default(0)
  totalAssignments    Int      @default(0)
  averageScore        Float    @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, monthNumber, weekNumber])
  @@map("progress")
}

// ============================================
// ACHIEVEMENT MODEL
// ============================================

enum AchievementType {
  MILESTONE
  SKILL_MASTERY
  ATTENDANCE
  PROJECT_EXCELLENCE
  COLLABORATION
  INNOVATION
}

model Achievement {
  id          String          @id @default(uuid())
  studentId   String
  type        AchievementType
  name        String
  description String
  criteria    String
  iconUrl     String?
  points      Int             @default(0)
  earnedAt    DateTime        @default(now())

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("achievements")
}

// ============================================
// CERTIFICATE MODEL
// ============================================

enum CertificateStatus {
  ISSUED
  REVOKED
  EXPIRED
}

model Certificate {
  id                String            @id @default(uuid())
  studentId         String
  certificateNumber String            @unique
  issueDate         DateTime          @default(now())
  expiryDate        DateTime?
  status            CertificateStatus @default(ISSUED)
  attendanceRate    Float
  projectsCompleted Int
  averageScore      Float
  capstonePassed    Boolean
  feedbackSubmitted Boolean
  skillsList        String[]
  finalGrade        String
  gradePercentage   Float
  pdfUrl            String?
  verificationUrl   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

// ============================================
// RECOMMENDATION MODEL
// ============================================

enum RecommendationType {
  RESOURCE
  PRACTICE_EXERCISE
  INTERVENTION
  MENTORSHIP
}

enum RecommendationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Recommendation {
  id          String                 @id @default(uuid())
  studentId   String
  type        RecommendationType
  priority    RecommendationPriority
  title       String
  description String
  actionUrl   String?
  isRead      Boolean                @default(false)
  isActioned  Boolean                @default(false)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("recommendations")
}

// ============================================
// FEEDBACK MODEL
// ============================================

enum FeedbackType {
  course
  instructor
  platform
  general
}

model Feedback {
  id           String       @id @default(uuid())
  studentId    String
  instructorId String?
  feedbackType FeedbackType
  rating       Int
  comments     String?
  isAnonymous  Boolean      @default(false)
  createdAt    DateTime     @default(now())

  // Relations
  student    Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor Instructor? @relation(fields: [instructorId], references: [id])

  @@map("feedback")
}

// ============================================
// ACTIVITY LOG MODEL
// ============================================

enum ActivityType {
  LOGIN
  LOGOUT
  PROJECT_SUBMITTED
  ASSIGNMENT_SUBMITTED
  CLASS_ATTENDED
  ACHIEVEMENT_EARNED
  SKILL_UPDATED
}

model Activity {
  id          String       @id @default(uuid())
  studentId   String
  type        ActivityType
  description String
  points      Int          @default(0)
  createdAt   DateTime     @default(now())

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("activities")
}

// ============================================
// RESOURCE MODEL
// ============================================

enum ResourceType {
  VIDEO
  ARTICLE
  DOCUMENTATION
  TUTORIAL
  BOOK
  TOOL
}

model Resource {
  id          String       @id @default(uuid())
  title       String
  description String?
  type        ResourceType
  url         String
  monthNumber Int?
  weekNumber  Int?
  topic       String
  tags        String[]
  isOfficial  Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("resources")
}

// ============================================
// NOTIFICATION MODEL
// ============================================

enum NotificationType {
  ANNOUNCEMENT
  ASSIGNMENT_DUE
  CLASS_REMINDER
  ACHIEVEMENT_EARNED
  PROJECT_REVIEWED
  ATTENDANCE_WARNING
  CERTIFICATE_READY
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  actionUrl String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// LEADERBOARD MODEL
// ============================================

model Leaderboard {
  id          String   @id @default(uuid())
  studentId   String
  period      String // weekly, monthly, overall
  rank        Int
  score       Int
  category    String // points, projects, attendance
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())

  @@map("leaderboard")
}

// ============================================
// RATE LIMIT MODEL
// ============================================

model RateLimit {
  id           String   @id @default(uuid())
  identifier   String // user ID or IP address
  endpoint     String
  requestCount Int      @default(1)
  windowStart  DateTime
  windowEnd    DateTime
  createdAt    DateTime @default(now())

  @@map("rate_limits")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_token")
}

// ============================================
// MESSAGING & CHAT SYSTEM
// ============================================

enum MessageType {
  TEXT
  FILE
  IMAGE
  CODE
  SYSTEM
}

enum ConversationType {
  DIRECT          // 1-on-1 chat
  GROUP           // Group chat
  COHORT_CHANNEL  // Cohort-wide channel
  CLASS_CHANNEL   // Class-specific channel
  ANNOUNCEMENT    // Admin announcements
}

model Conversation {
  id          String           @id @default(uuid())
  name        String?          // For group chats
  type        ConversationType
  cohortId    String?
  classId     String?
  isArchived  Boolean          @default(false)
  createdBy   String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  lastMessageAt DateTime?

  // Relations
  participants ConversationParticipant[]
  messages     Message[]
  cohort       Cohort?   @relation(fields: [cohortId], references: [id])
  class        Class?    @relation(fields: [classId], references: [id])

  @@index([cohortId, type])
  @@index([classId, type])
  @@index([lastMessageAt])
  @@map("conversations")
}

model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  role           String   @default("MEMBER") // MEMBER, ADMIN, MODERATOR
  joinedAt       DateTime @default(now())
  lastReadAt     DateTime @default(now())
  isMuted        Boolean  @default(false)
  isPinned       Boolean  @default(false)

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  senderId       String
  content        String      @db.Text
  type           MessageType @default(TEXT)
  fileUrl        String?
  fileName       String?
  fileSize       Int?
  isEdited       Boolean     @default(false)
  isDeleted      Boolean     @default(false)
  parentId       String?     // For replies/threads
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  conversation Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User          @relation(fields: [senderId], references: [id])
  reactions    MessageReaction[]
  readReceipts MessageReadReceipt[]
  parent       Message?      @relation("MessageThread", fields: [parentId], references: [id])
  replies      Message[]     @relation("MessageThread")

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([parentId])
  @@map("messages")
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@map("message_reactions")
}

model MessageReadReceipt {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_read_receipts")
}

// ============================================
// ONLINE STATUS TRACKING
// ============================================

model OnlineStatus {
  id           String   @id @default(uuid())
  userId       String   @unique
  isOnline     Boolean  @default(false)
  lastSeenAt   DateTime @default(now())
  currentPage  String?
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("online_status")
}